#!/usr/bin/env bash

set -e
set -o pipefail
set -u

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
BP_DIR=$(
    cd $(dirname $0)
    cd ..
    pwd
)

if [ -f "${ENV_DIR}/KONG_GIT_URL" ]; then
    KONG_GIT_URL=$(cat ${ENV_DIR}/KONG_GIT_URL)
else
    KONG_GIT_URL="https://github.com/kong/kong.git"
fi

if [ -f "${ENV_DIR}/KONG_GIT_COMMIT" ]; then
    KONG_GIT_COMMIT="${ENV_DIR}/KONG_GIT_COMMIT"
else
    KONG_GIT_COMMIT="5cdce7c19dd7d65e02794c782baf96efbcf4a0f8"
fi

LUAROCKS_VERSION=3.1.3
OPENSSL_VERSION=1.1.1b
OPENRESTY_VERSION=1.15.8.1

# for ld-config
export PATH=$PATH:/sbin

function error() {
    echo " !     $*" >&2
    exit 1
}

function topic() {
    echo "-----> $*"
}

function indent() {
    c='s/^/       /'
    case $(uname) in
    Darwin) sed -l "$c" ;;
    *) sed -u "$c" ;;
    esac
}

# APT

APT_CACHE_DIR="$CACHE_DIR/apt/cache"
APT_STATE_DIR="$CACHE_DIR/apt/state"
mkdir -p "$APT_CACHE_DIR/archives/partial"
mkdir -p "$APT_STATE_DIR/lists/partial"

APT_OPTIONS="-o debug::nolocking=true -o dir::cache=$APT_CACHE_DIR -o dir::state=$APT_STATE_DIR"

topic "Updating apt caches"

apt-get $APT_OPTIONS update | indent

for PACKAGE in $(cat $BP_DIR/Aptfile $BUILD_DIR/Aptfile); do
    topic "Install $PACKAGE"
    apt-get $APT_OPTIONS -y --allow-downgrades --allow-remove-essential --allow-change-held-packages -d install $PACKAGE | indent
done

# openresty-build-tools
KONG_RUNTIME=kong-runtime
APP_PREFIX="$CACHE_DIR/$KONG_RUNTIME"
mkdir -p $APP_PREFIX

ls $APP_PREFIX

cd $APP_PREFIX
topic "Build Kong Dependencies"
# if [ ! -d "$APP_PREFIX/openresty-build-tools" ]; then
#     git clone https://github.com/Kong/openresty-build-tools.git
#     cd openresty-build-tools
#     ./kong-ngx-build \
#         -p buildroot \
#         --openresty $OPENRESTY_VERSION \
#         --openssl $OPENSSL_VERSION \
#         --luarocks $LUAROCKS_VERSION
#     cd ..
# fi
# buildroot/openresty/luajit/bin/luajit -v
# sed -i "s#/build/#$APP_PREFIX/#g" buildroot/luarocks/bin/luarocks
# ln -s -f buildroot/openresty/bin/openresty buildroot/openresty/nginx/sbin/nginx
# rm -f buildroot/openresty/bin/openresty
# buildroot/openresty/nginx/sbin/nginx -v
# ln -s buildroot/openresty/nginx/sbin/nginx buildroot/openresty/bin/openresty
# buildroot/openresty/bin/openresty -v
# cp buildroot/openresty/nginx/sbin/nginx buildroot/openresty/bin/openresty
# sed -i "s#/build/#$APP_PREFIX/#g" buildroot/openresty/bin/openresty
# ln -s -f buildroot/openresty/luajit/bin/luajit buildroot/openresty/luajit/bin/luajit-2.1.0-beta3
export PATH="$APP_PREFIX/openresty-build-tools/buildroot/luarocks/bin:$APP_PREFIX/openresty-build-tools/buildroot/openresty/nginx/sbin:$APP_PREFIX/openresty-build-tools/buildroot/openresty/bin:$APP_PREFIX/kong/bin:$APP_PREFIX/openresty-build-tools/buildroot/openresty/luajit/bin:$PATH"
luarocks --version
openresty -v
nginx -v
luajit -v

topic "Install Kong"
# git clone "$KONG_GIT_URL"
# cd kong
# git checkout "$KONG_GIT_COMMIT"
# make install

cd ${BP_DIR}
echo 'export PATH="$APP_PREFIX/openresty-build-tools/buildroot/luarocks/bin:$APP_PREFIX/openresty-build-tools/buildroot/openresty/nginx/sbin:$APP_PREFIX/openresty-build-tools/buildroot/openresty/bin:$APP_PREFIX/kong/bin:$APP_PREFIX/openresty-build-tools/buildroot/openresty/luajit/bin:$PATH"' >>.profile.d/kong-config.sh
mkdir -p $BUILD_DIR/.profile.d
mv .profile.d/* $BUILD_DIR/.profile.d
mkdir -p $BUILD_DIR/config
mv config/* $BUILD_DIR/config
# Move executables for Procfile into place
mkdir -p $BUILD_DIR/bin
cp $BP_DIR/bin/app/kong-* $BUILD_DIR/bin/

# mv $APP_PREFIX $BUILD_DIR/$KONG_RUNTIME
# export PATH="$BUILD_DIR/$KONG_RUNTIME/openresty-build-tools/buildroot/luarocks/bin:$BUILD_DIR/$KONG_RUNTIME/openresty-build-tools/buildroot/openresty/nginx/sbin:$BUILD_DIR/$KONG_RUNTIME/openresty-build-tools/buildroot/openresty/bin:$BUILD_DIR/$KONG_RUNTIME/kong/bin:$PATH"
# luarocks --version
# openresty -v
# nginx -v
eval "$(luarocks path)"
kong version -vv

# set_env PATH "$APP_PREFIX/openresty-build-tools/buildroot/luarocks/bin:$APP_PREFIX/openresty-build-tools/buildroot/openresty/nginx/sbin:$APP_PREFIX/openresty-build-tools/buildroot/openresty/bin:$APP_PREFIX/kong/bin:$PATH"
